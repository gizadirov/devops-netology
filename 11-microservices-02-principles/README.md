
# Домашнее задание к занятию «Микросервисы: принципы»

Вы работаете в крупной компании, которая строит систему на основе микросервисной архитектуры.
Вам как DevOps-специалисту необходимо выдвинуть предложение по организации инфраструктуры для разработки и эксплуатации.

## Задача 1: API Gateway 

Предложите решение для обеспечения реализации API Gateway. Составьте сравнительную таблицу возможностей различных программных решений. На основе таблицы сделайте выбор решения.

Решение должно соответствовать следующим требованиям:
- маршрутизация запросов к нужному сервису на основе конфигурации,
- возможность проверки аутентификационной информации в запросах,
- обеспечение терминации HTTPS.

Обоснуйте свой выбор.
## Ответ
| API Gateway    | Маршрутизация запросов | Проверка аутентификации | Терминация TLS | Облачное решение | Docker  | Open Source |
| -------------- | --------------------- | ----------------------- | -------------- | ---------------- | ------- | ----------- |
| Kong           | Да                    | Да                      | Да             | Да               | Да      | Да          |
| Tyk            | Да                    | Да                      | Да             | Да               | Да      | Да          |
| Apigee         | Да                    | Да                      | Да             | Да               | Нет     | Нет         |
| AWS API Gateway| Да                    | Да                      | Да             | Да               | Нет     | Нет         |
| Azure API Management| Да                | Да                      | Да             | Да               | Нет     | Нет         |
| Ambassador     | Да                    | Да                      | Да             | Да               | Да      | Да          |
| Nginx          | Да                    | Да                      | Да             | Нет              | Да      | Да          |
| Traefik        | Да                    | Да                      | Да             | Нет              | Да      | Да          |
| WSO2 API Manager| Да                   | Да                      | Да             | Да               | Нет     | Да          |
| Express Gateway| Да                    | Да                      | Да             | Нет              | Да      | Да          |

В качестве решения можно предложить **nginx**. Он соответствует всем требованиям, бесплатен, популярен, хорошо поддерживаемый, прост в конфигурации, поддерживает модули, хорошо работает в контейнерах, open source. Обычно ставится как load balancer и reverse proxy, поэтому нет необходимости в дополнительном продукте. К минусам можно отнести поддержку не всех методов auth (JWT есть только в платном nginx plus), отсутствие cloud решения. Как альтернативу можно рассмотреть Kong.


## Задача 2: Брокер сообщений

Составьте таблицу возможностей различных брокеров сообщений. На основе таблицы сделайте обоснованный выбор решения.

Решение должно соответствовать следующим требованиям:
- поддержка кластеризации для обеспечения надёжности,
- хранение сообщений на диске в процессе доставки,
- высокая скорость работы,
- поддержка различных форматов сообщений,
- разделение прав доступа к различным потокам сообщений,
- простота эксплуатации.

Обоснуйте свой выбор.
## Ответ

| Брокер сообщений | Кластеризация | Хранение на диске | Скорость работы | Поддержка форматов | Разделение прав доступа | Простота эксплуатации | Облачное решение | Docker  | Open Source |
| ---------------- | ------------- | ---------------- | --------------- | ------------------ | ---------------------- | -------------------- | ---------------- | ------- | ----------- |
| RabbitMQ         | Да            | Да               | Высокая         | Да                 | Да                     | Да                   | Нет              | Да      | Да          |
| Apache Kafka     | Да            | Да               | Очень высокая   | Да                 | Да                     | Нет                  | Да               | Да      | Да          |
| ActiveMQ         | Да            | Да               | Средняя         | Да                 | Да                     | Да                   | Нет              | Нет     | Да          |
| NATS             | Да            | Нет              | Очень высокая   | Да                 | Нет                    | Да                   | Нет              | Да      | Да          |
| Apache Pulsar    | Да            | Да               | Очень высокая   | Да                 | Да                     | Да                   | Да               | Да      | Да          |
| IBM MQ           | Да            | Да               | Очень высокая   | Да                 | Да                     | Нет                  | Да               | Нет     | Нет         |
| AWS SQS          | Да            | Да               | Высокая         | Да                 | Да                     | Да                   | Да               | Нет     | Нет         |
| Google Cloud Pub/Sub| Да          | Да               | Высокая         | Да                 | Да                     | Да                   | Да               | Нет     | Нет         |
| Apache RocketMQ  | Да            | Да               | Очень высокая   | Да                 | Да                     | Нет                  | Нет              | Нет     | Да          |
| NATS Streaming   | Да            | Да               | Очень высокая   | Да                 | Нет                    | Нет                  | Нет              | Нет     | Да          |

В качестве решения можно предложить **RabbitMQ**. Этот брокер гибкий и масштабируемый, использует стандартный протокол для обмена сообщениями AMQP, имееь возможности гибкой маршрутизации, надежен и отказоустойчив, расширяем. Это очень популярный брокер, имеет большое комьюнити, open source. Как альтернативу можно предложить **Kafka**, который сложнее в эксплуатации, но новее, быстрее, и в зависимости от задач, может стать предпочтительнее.

## Задача 3: API Gateway * (необязательная)

### Есть три сервиса:

**minio**
- хранит загруженные файлы в бакете images,
- S3 протокол,

**uploader**
- принимает файл, если картинка сжимает и загружает его в minio,
- POST /v1/upload,

**security**
- регистрация пользователя POST /v1/user,
- получение информации о пользователе GET /v1/user,
- логин пользователя POST /v1/token,
- проверка токена GET /v1/token/validation.

### Необходимо воспользоваться любым балансировщиком и сделать API Gateway:

**POST /v1/register**
1. Анонимный доступ.
2. Запрос направляется в сервис security POST /v1/user.

**POST /v1/token**
1. Анонимный доступ.
2. Запрос направляется в сервис security POST /v1/token.

**GET /v1/user**
1. Проверка токена. Токен ожидается в заголовке Authorization. Токен проверяется через вызов сервиса security GET /v1/token/validation/.
2. Запрос направляется в сервис security GET /v1/user.

**POST /v1/upload**
1. Проверка токена. Токен ожидается в заголовке Authorization. Токен проверяется через вызов сервиса security GET /v1/token/validation/.
2. Запрос направляется в сервис uploader POST /v1/upload.

**GET /v1/user/{image}**
1. Проверка токена. Токен ожидается в заголовке Authorization. Токен проверяется через вызов сервиса security GET /v1/token/validation/.
2. Запрос направляется в сервис minio GET /images/{image}.

### Ожидаемый результат

Результатом выполнения задачи должен быть docker compose файл, запустив который можно локально выполнить следующие команды с успешным результатом.
Предполагается, что для реализации API Gateway будет написан конфиг для NGinx или другого балансировщика нагрузки, который будет запущен как сервис через docker-compose и будет обеспечивать балансировку и проверку аутентификации входящих запросов.
Авторизация
curl -X POST -H 'Content-Type: application/json' -d '{"login":"bob", "password":"qwe123"}' http://localhost/token

**Загрузка файла**

curl -X POST -H 'Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJib2IifQ.hiMVLmssoTsy1MqbmIoviDeFPvo-nCd92d4UFiN2O2I' -H 'Content-Type: octet/stream' --data-binary @yourfilename.jpg http://localhost/upload

**Получение файла**
curl -X GET http://localhost/images/4e6df220-295e-4231-82bc-45e4b1484430.jpg

### Ответ
[nginx.conf](nginx.conf)
```
events {}
http {
	upstream minio {
		server storage:9000;
	}
	upstream uploader {
		server uploader:3000;
	}
	upstream security {
		server security:3000;
	}

	server {
		listen 8080;
		server_name localhost;
		location /v1/ {
			location  /v1/token/validation {
    			#internal;
    			proxy_pass http://security;
			}
			location /v1/user/(.*) {
				if ($request_method != GET) {
                                    return 405;
        		        }
				auth_request /v1/token/validation;
				proxy_pass http://minio/$1;
			}
			location /v1/upload {
				if ($request_method != POST) {
                                    return 405;
        		        }
				auth_request /v1/token/validation;
				proxy_pass http://uploader;
			}
			location /v1/user {
				if ($request_method != GET) {
                                    return 405;
        		        }
				auth_request /v1/token/validation;
				proxy_pass http://security;
			}
			location /v1/token {
				if ($request_method != POST) {
                                    return 405;
        		        }
				proxy_pass http://security;
			}
			location /v1/register {
				if ($request_method != POST) {
                                    return 405;
        		        }
				proxy_pass http://security/v1/user/;
			}
			
		}	
	}
}
```