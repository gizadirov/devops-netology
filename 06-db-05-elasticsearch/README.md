# Домашнее задание к занятию 5. «Elasticsearch»## Задача 1- составьте Dockerfile-манифест для Elasticsearch,- соберите Docker-образ и сделайте `push` в ваш docker.io-репозиторий,- запустите контейнер из получившегося образа и выполните запрос пути `/` c хост-машины.Требования к `elasticsearch.yml`:- данные `path` должны сохраняться в `/var/lib`,- имя ноды должно быть `netology_test`.В ответе приведите:- текст Dockerfile-манифеста,- ссылку на образ в репозитории dockerhub,- ответ `Elasticsearch` на запрос пути `/` в json-виде.## Ответ```dockerfileFROM centos:7RUN yum -y install wget perl-Digest-SHA && \    cd /opt && \    wget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-8.2.0-linux-x86_64.tar.gz && \    wget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-8.2.0-linux-x86_64.tar.gz.sha512 && \    shasum -a 512 -c elasticsearch-8.2.0-linux-x86_64.tar.gz.sha512 && \    tar -xzf elasticsearch-8.2.0-linux-x86_64.tar.gz && \    mkdir /var/lib/data && chmod -R 777 /var/lib/data && \    groupadd elasticsearch && \    useradd -g elasticsearch elasticsearch &&\    chown -R elasticsearch:elasticsearch /opt/elasticsearch-8.2.0 && \    rm elasticsearch-8.2.0-linux-x86_64.tar.gz elasticsearch-8.2.0-linux-x86_64.tar.gz.sha512 && \     yum -y remove wget perl-Digest-SHA && yum clean allWORKDIR /opt/elasticsearch-8.2.0/COPY --chown=elasticsearch elasticsearch.yml  config/USER elasticsearchEXPOSE 9200 9300ENTRYPOINT ["bin/elasticsearch"]``````commandlinehttps://hub.docker.com/r/timurkinx/elasticsearch``````commandlinecurl --insecure -u elastic https://localhost:9200Enter host password for user 'elastic':{  "name" : "netology_test",  "cluster_name" : "elasticsearch",  "cluster_uuid" : "kTFdwbvhS2COz0C4GbE7bw",  "version" : {    "number" : "8.2.0",    "build_flavor" : "default",    "build_type" : "tar",    "build_hash" : "b174af62e8dd9f4ac4d25875e9381ffe2b9282c5",    "build_date" : "2022-04-20T10:35:10.180408517Z",    "build_snapshot" : false,    "lucene_version" : "9.1.0",    "minimum_wire_compatibility_version" : "7.17.0",    "minimum_index_compatibility_version" : "7.0.0"  },  "tagline" : "You Know, for Search"}```## Задача 2В этом задании вы научитесь:- создавать и удалять индексы,- изучать состояние кластера,- обосновывать причину деградации доступности данных.Ознакомьтесь с [документацией](https://www.elastic.co/guide/en/elasticsearch/reference/current/indices-create-index.html) и добавьте в `Elasticsearch` 3 индекса в соответствии с таблицей:| Имя | Количество реплик | Количество шард ||-----|-------------------|-----------------|| ind-1| 0 | 1 || ind-2 | 1 | 2 || ind-3 | 2 | 4 |Получите список индексов и их статусов, используя API, и **приведите в ответе** на задание.Получите состояние кластера `Elasticsearch`, используя API.Как вы думаете, почему часть индексов и кластер находятся в состоянии yellow?Удалите все индексы.**Важно**При проектировании кластера Elasticsearch нужно корректно рассчитывать количество реплик и шард,иначе возможна потеря данных индексов, вплоть до полной, при деградации системы.## Ответ```commandlinecurl -X GET --insecure -u elastic "https://localhost:9200/_cat/indices?v=true"Enter host password for user 'elastic':health status index uuid                   pri rep docs.count docs.deleted store.size pri.store.sizeyellow open   ind-2 fYdWr_b9Q-mI0GWYILQW5A   2   1          0            0       450b           450byellow open   ind-3 opclJtJUQ7qOlZ9v5PBdFQ   4   2          0            0       900b           900bgreen  open   ind-1 Lh2lU1vaRby-Mxl_6hbNpg   1   0          0            0       225b           225b``````commandline# полное состояние можно узнать, вызвав _cluster/statecurl --insecure -u elastic -XGET 'https://localhost:9200/_cluster/health?pretty'Enter host password for user 'elastic':{  "cluster_name" : "elasticsearch",  "status" : "yellow",  "timed_out" : false,  "number_of_nodes" : 1,  "number_of_data_nodes" : 1,  "active_primary_shards" : 9,  "active_shards" : 9,  "relocating_shards" : 0,  "initializing_shards" : 0,  "unassigned_shards" : 10,  "delayed_unassigned_shards" : 0,  "number_of_pending_tasks" : 0,  "number_of_in_flight_fetch" : 0,  "task_max_waiting_in_queue_millis" : 0,  "active_shards_percent_as_number" : 47.368421052631575}```Часть индексов находятся в состоянии yellow, потому что для них указаны реплики (> 0), которые для отказоустойчивости должны размещаться в других data-node, а у нас только одна data-node. ```commandlinecurl -X DELETE --insecure -u elastic "https://localhost:9200/ind-1?pretty"curl -X DELETE --insecure -u elastic "https://localhost:9200/ind-2?pretty"curl -X DELETE --insecure -u elastic "https://localhost:9200/ind-3?pretty"```## Задача 3В этом задании вы научитесь:- создавать бэкапы данных,- восстанавливать индексы из бэкапов.Создайте директорию `{путь до корневой директории с Elasticsearch в образе}/snapshots`.Используя API, [зарегистрируйте](https://www.elastic.co/guide/en/elasticsearch/reference/current/snapshots-register-repository.html#snapshots-register-repository) эту директорию как `snapshot repository` c именем `netology_backup`.**Приведите в ответе** запрос API и результат вызова API для создания репозитория.Создайте индекс `test` с 0 реплик и 1 шардом и **приведите в ответе** список индексов.[Создайте `snapshot`](https://www.elastic.co/guide/en/elasticsearch/reference/current/snapshots-take-snapshot.html) состояния кластера `Elasticsearch`.**Приведите в ответе** список файлов в директории со `snapshot`.Удалите индекс `test` и создайте индекс `test-2`. **Приведите в ответе** список индексов.[Восстановите](https://www.elastic.co/guide/en/elasticsearch/reference/current/snapshots-restore-snapshot.html) состояниекластера `Elasticsearch` из `snapshot`, созданного ранее. **Приведите в ответе** запрос к API восстановления и итоговый список индексов.## ОтветЗапрос API и результат вызова API для создания репозитория:```commandlinecurl -X PUT --insecure -u elastic:elastic "https://localhost:9200/_snapshot/netology_backup?pretty" -H 'Content-Type: application/json' -d'    {      "type": "fs",      "settings": {        "location": "/opt/elasticsearch-8.2.0/snapshots"      }    }'{  "acknowledged" : true}```Cоздаем индекс `test`. Список индексов:```commandlinecurl -X GET --insecure -u elastic:elastic "https://localhost:9200/_cat/indices?v=true"health status index uuid                   pri rep docs.count docs.deleted store.size pri.store.sizegreen  open   test  SP0Nq85LQyiqo5QbJ8i__A   1   0          0            0       225b           225b```Создаем `snapshot`. Список файлов в директории со `snapshot`:```commandlinedocker exec -it elastic ls -l /opt/elasticsearch-8.2.0/snapshotstotal 36-rw-r--r-- 1 elasticsearch elasticsearch  1107 Apr 29 08:12 index-0-rw-r--r-- 1 elasticsearch elasticsearch     8 Apr 29 08:12 index.latestdrwxr-xr-x 5 elasticsearch elasticsearch  4096 Apr 29 08:12 indices-rw-r--r-- 1 elasticsearch elasticsearch 16524 Apr 29 08:12 meta-rAK35IM2RaeD40s5WujpKA.dat-rw-r--r-- 1 elasticsearch elasticsearch   394 Apr 29 08:12 snap-rAK35IM2RaeD40s5WujpKA.dat```Cоздаем индекс `test-2`. Список индексов:```commandlinecurl -X GET --insecure -u elastic:elastic "https://localhost:9200/_cat/indices?v=true"health status index  uuid                   pri rep docs.count docs.deleted store.size pri.store.sizegreen  open   test-2 ujeGXI4aQaubxVaLXZeq6Q   1   0          0            0       225b           225b```Запрос к API восстановления и итоговый список индексов:```commandlinecurl -X GET --insecure -u elastic:elastic "https://localhost:9200/_snapshot/netology_backup/*?verbose=false&pretty"{  "snapshots" : [    {      "snapshot" : "my_snapshot_2023.04.29",      "uuid" : "rAK35IM2RaeD40s5WujpKA",      "repository" : "netology_backup",      "indices" : [        ".geoip_databases",        ".security-7",        "test"      ],      "data_streams" : [ ],      "state" : "SUCCESS"    }  ],  "total" : 1,  "remaining" : 0}curl -X POST --insecure -u elastic:elastic "https://localhost:9200/_snapshot/netology_backup/my_snapshot_2023.04.29/_restore?pretty" -H 'Content-Type: application/json' -d'{   "indices": "*",   "include_global_state": true}'{  "accepted" : true}curl -X GET --insecure -u elastic:elastic "https://localhost:9200/_cat/indices?v=true"health status index  uuid                   pri rep docs.count docs.deleted store.size pri.store.sizegreen  open   test-2 ujeGXI4aQaubxVaLXZeq6Q   1   0          0            0       225b           225bgreen  open   test   Iy-j7tTbTOOupowypFNa7g   1   0          0            0       225b           225b```---