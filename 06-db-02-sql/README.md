# Домашнее задание к занятию 2. «SQL»## Задача 1Используя Docker, поднимите инстанс PostgreSQL (версию 12) c 2 volume, в который будут складываться данные БД и бэкапы.Приведите получившуюся команду или docker-compose-манифест.## Ответ```docker volume create pg-data-1docker volume create pg-backups``````version: '3.1'services:  postgres_1:    image: postgres:12-alpine    restart: always    volumes:      - pg-data-1:/var/lib/postgresql/data      - pg-backups:/var/lib/postgresql/backups    environment:      POSTGRES_PASSWORD: passvolumes:  pg-data-1:    external: true  pg-backups:    external: true```## Задача 2В БД из задачи 1: - создайте пользователя test-admin-user и БД test_db;- в БД test_db создайте таблицу orders и clients (спeцификация таблиц ниже);- предоставьте привилегии на все операции пользователю test-admin-user на таблицы БД test_db;- создайте пользователя test-simple-user;- предоставьте пользователю test-simple-user права на SELECT/INSERT/UPDATE/DELETE этих таблиц БД test_db.Таблица orders:- id (serial primary key);- наименование (string);- цена (integer).Таблица clients:- id (serial primary key);- фамилия (string);- страна проживания (string, index);- заказ (foreign key orders).Приведите:- итоговый список БД после выполнения пунктов выше;- описание таблиц (describe);- SQL-запрос для выдачи списка пользователей с правами над таблицами test_db;- список пользователей с правами над таблицами test_db.## Ответ- итоговый список БД после выполнения пунктов выше:```commandlinepostgres=# \l                                 List of databases   Name    |  Owner   | Encoding |  Collate   |   Ctype    |   Access privileges-----------+----------+----------+------------+------------+----------------------- postgres  | postgres | UTF8     | en_US.utf8 | en_US.utf8 | template0 | postgres | UTF8     | en_US.utf8 | en_US.utf8 | =c/postgres          +           |          |          |            |            | postgres=CTc/postgres template1 | postgres | UTF8     | en_US.utf8 | en_US.utf8 | =c/postgres          +           |          |          |            |            | postgres=CTc/postgres test_db   | postgres | UTF8     | en_US.utf8 | en_US.utf8 |(4 rows)```- описание таблиц (describe):```commandlinetest_db=# \d orders                                       Table "public.orders"    Column    |          Type          | Collation | Nullable |              Default--------------+------------------------+-----------+----------+------------------------------------ id           | integer                |           | not null | nextval('orders_id_seq'::regclass) наименование | character varying(200) |           | not null | цена         | integer                |           | not null |Indexes:    "orders_pkey" PRIMARY KEY, btree (id)Referenced by:    TABLE "clients" CONSTRAINT "clients_заказ_fkey" FOREIGN KEY ("заказ") REFERENCES orders(id)``````commandlinetest_db=# \d clients                                         Table "public.clients"      Column       |          Type          | Collation | Nullable |               Default-------------------+------------------------+-----------+----------+------------------------------------- id                | integer                |           | not null | nextval('clients_id_seq'::regclass) фамилия           | character varying(200) |           | not null | страна проживания | character varying(200) |           | not null | заказ             | integer                |           |          |Indexes:    "clients_pkey" PRIMARY KEY, btree (id)    "idx_страна_проживания" btree ("страна проживания")Foreign-key constraints:    "clients_заказ_fkey" FOREIGN KEY ("заказ") REFERENCES orders(id)```- SQL-запрос для выдачи списка пользователей с правами над таблицами test_db:```commandlineSELECT grantee, privilege_type, table_nameFROM information_schema.role_table_grantsWHERE table_name='orders' or table_name='clients';```- список пользователей с правами над таблицами test_db:```commandline     grantee      | privilege_type | table_name------------------+----------------+------------ postgres         | INSERT         | orders postgres         | SELECT         | orders postgres         | UPDATE         | orders postgres         | DELETE         | orders postgres         | TRUNCATE       | orders postgres         | REFERENCES     | orders postgres         | TRIGGER        | orders test-admin-user  | INSERT         | orders test-admin-user  | SELECT         | orders test-admin-user  | UPDATE         | orders test-admin-user  | DELETE         | orders test-admin-user  | TRUNCATE       | orders test-admin-user  | REFERENCES     | orders test-admin-user  | TRIGGER        | orders test-simple-user | INSERT         | orders test-simple-user | SELECT         | orders test-simple-user | UPDATE         | orders test-simple-user | DELETE         | orders postgres         | INSERT         | clients postgres         | SELECT         | clients postgres         | UPDATE         | clients postgres         | DELETE         | clients postgres         | TRUNCATE       | clients postgres         | REFERENCES     | clients postgres         | TRIGGER        | clients test-admin-user  | INSERT         | clients test-admin-user  | SELECT         | clients test-admin-user  | UPDATE         | clients test-admin-user  | DELETE         | clients test-admin-user  | TRUNCATE       | clients test-admin-user  | REFERENCES     | clients test-admin-user  | TRIGGER        | clients test-simple-user | INSERT         | clients test-simple-user | SELECT         | clients test-simple-user | UPDATE         | clients test-simple-user | DELETE         | clients(36 rows)```## Задача 3Используя SQL-синтаксис, наполните таблицы следующими тестовыми данными:Таблица orders|Наименование|цена||------------|----||Шоколад| 10 ||Принтер| 3000 ||Книга| 500 ||Монитор| 7000||Гитара| 4000|Таблица clients|ФИО|Страна проживания||------------|----||Иванов Иван Иванович| USA ||Петров Петр Петрович| Canada ||Иоганн Себастьян Бах| Japan ||Ронни Джеймс Дио| Russia||Ritchie Blackmore| Russia|Используя SQL-синтаксис:- вычислите количество записей для каждой таблицы.Приведите в ответе:    - запросы,    - результаты их выполнения.## Ответ```commandlinetest_db=# INSERT INTO orders VALUEStest_db-# (DEFAULT, 'Шоколад', 10),test_db-# (DEFAULT, 'Принтер', 3000),test_db-# (DEFAULT, 'Книга', 500),test_db-# (DEFAULT, 'Монитор', 7000),test_db-# (DEFAULT, 'Гитара', 4000);INSERT 0 5test_db=# INSERT INTO clients VALUEStest_db-# (DEFAULT, 'Иванов Иван Иванович', 'USA'),test_db-# (DEFAULT, 'Петров Петр Петрович', 'Canada'),test_db-# (DEFAULT, 'Иоганн Себастьян Бах', 'Japan'),test_db-# (DEFAULT, 'Ронни Джеймс Дио', 'Russia'),test_db-# (DEFAULT, 'Ritchie Blackmore', 'Russia');INSERT 0 5``````commandlinetest_db=# SELECT COUNT(*) FROM orders; count-------     5(1 row)test_db=# SELECT COUNT(*) FROM clients; count-------     5(1 row)```## Задача 4Часть пользователей из таблицы clients решили оформить заказы из таблицы orders.Используя foreign keys, свяжите записи из таблиц, согласно таблице:|ФИО|Заказ||------------|----||Иванов Иван Иванович| Книга ||Петров Петр Петрович| Монитор ||Иоганн Себастьян Бах| Гитара |Приведите SQL-запросы для выполнения этих операций.Приведите SQL-запрос для выдачи всех пользователей, которые совершили заказ, а также вывод этого запроса. Подсказка: используйте директиву `UPDATE`.## Ответ```commandlinetest_db=# UPDATE clients SET заказ=8 where id=6;UPDATE 1test_db=# UPDATE clients SET заказ=9 where id=7;UPDATE 1test_db=# UPDATE clients SET заказ=10 where id=8;UPDATE 1``````commandlinetest_db=# SELECT * FROM clients WHERE заказ IS NOT NULL; id |       фамилия        | страна проживания | заказ----+----------------------+-------------------+-------  6 | Иванов Иван Иванович | USA               |     8  7 | Петров Петр Петрович | Canada            |     9  8 | Иоганн Себастьян Бах | Japan             |    10(3 rows)```## Задача 5Получите полную информацию по выполнению запроса выдачи всех пользователей из задачи 4 (используя директиву EXPLAIN).Приведите получившийся результат и объясните, что значат полученные значения.## Ответ```commandlinetest_db=# EXPLAIN SELECT * FROM clients WHERE заказ IS NOT NULL;                        QUERY PLAN----------------------------------------------------------- Seq Scan on clients  (cost=0.00..10.90 rows=90 width=844)   Filter: ("заказ" IS NOT NULL)(2 rows)```cost=  0.00 - ориентировочная стоимость запуска. Это время, затрачиваемое до того, как может начаться фаза вывода, например, время для выполнения сортировки.   10.90 - ориентировочная общая стоимость.  rows=90 - предполагаемое количество строк, выводимых этим узлом плана.  width=844 - расчетная средняя ширина строк, выводимых этим узлом плана (в байтах).  Filter: ("заказ" IS NOT NULL) - Условие в WHERE.## Задача 6Создайте бэкап БД test_db и поместите его в volume, предназначенный для бэкапов (см. задачу 1).Остановите контейнер с PostgreSQL, но не удаляйте volumes.Поднимите новый пустой контейнер с PostgreSQL.Восстановите БД test_db в новом контейнере.Приведите список операций, который вы применяли для бэкапа данных и восстановления. ---## Ответ```commandlinedocker compose exec postgres_1 bashc919ea51d2c0:/# pg_dump -U postgres test_db > /var/lib/postgresql/backups/test_db_dump.sqlc919ea51d2c0:/# exitdocker stop 1-postgres_1-1docker volume create pg-data-2``````commandlineversion: '3.1'services:  postgres_2:    image: postgres:12-alpine    restart: always    volumes:      - pg-data-2:/var/lib/postgresql/data      - pg-backups:/var/lib/postgresql/backups    environment:      POSTGRES_PASSWORD: passvolumes:  pg-data-2:    external: true  pg-backups:    external: true``````cd ../2docker compose up -d [+] Running 2/2 ✔ Network 2_default         Created ✔ Container 2-postgres_2-1  Starteddocker compose exec postgres_2 bash3801faeb381f:/# psql -U postgrespsql (12.14)Type "help" for help.postgres=# CREATE DATABASE test_db;CREATE DATABASEpostgres=# CREATE ROLE "test-admin-user"; CREATE ROLE "test-simple-user";CREATE ROLECREATE ROLEpostgres=# \q3801faeb381f:/# psql -U postgres test_db < /var/lib/postgresql/backups/test_db_dump.sql3801faeb381f:/# psql -U postgrespostgres-# \c test_dbYou are now connected to database "test_db" as user "postgres".test_db-# \d               List of relations Schema |      Name      |   Type   |  Owner--------+----------------+----------+---------- public | clients        | table    | postgres public | clients_id_seq | sequence | postgres public | orders         | table    | postgres public | orders_id_seq  | sequence | postgres(4 rows)```